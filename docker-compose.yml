# ============================================================================
# Ash-Dash v5.0 Docker Compose Configuration
# ============================================================================
# FILE VERSION: v5.0-4-1.0-1
# LAST MODIFIED: 2026-01-17
# Repository: https://github.com/the-alphabet-cartel/ash-dash
# Community: The Alphabet Cartel - https://discord.gg/alphabetcartel
# ============================================================================
#
# USAGE:
#   # Start services
#   docker compose up -d
#
#   # View logs
#   docker compose logs -f ash-dash
#
#   # Stop services
#   docker compose down
#
#   # Rebuild and start (after frontend changes)
#   docker compose up -d --build
#
# DOCKER-FIRST PHILOSOPHY:
#   - Frontend built inside Docker (no Node.js on host)
#   - FastAPI serves built static files on port 30883
#   - Single container serves both API and frontend
#
# SECRETS:
#   Secrets are stored in ./secrets/ directory:
#   - ./secrets/archive_master_key        - AES-256 encryption key for archives
#   - ./secrets/ash_dash_discord_alert_token - Discord webhook for Ash-Dash alerts
#   - ./secrets/minio_root_user           - MinIO username
#   - ./secrets/minio_root_password       - MinIO password
#   - ./secrets/oidc_client_secret        - PocketID OIDC client secret
#   - ./secrets/postgres_token            - PostgreSQL password
#   - ./secrets/redis_token               - Redis password
#
# REQUIREMENTS:
#   - Docker Engine 24.0+
#   - Docker Compose v2.20+
#
# ============================================================================

### Common Variables ###
x-common: &common
  networks:
    - ash-network
  restart: unless-stopped

### Common Environmental Variables ###
x-env: &env
  PGID: ${PGID:-1000}
  PUID: ${PUID:-1000}
  TZ: ${TZ:-America/Los_Angeles}
  FORCE_COLOR: ${FORCE_COLOR:-1}

### Healthchecks ###
x-health: &health
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 120s
  start_interval: 10s

services:
  # ===========================================================================
  # Ash-Dash Service - Crisis Detection Dashboard (FastAPI + Vue.js)
  # ===========================================================================
  ash-dash:
    image: ghcr.io/the-alphabet-cartel/ash-dash:latest
    container_name: ash-dash
    build:
      context: .
      dockerfile: Dockerfile
    <<: *common

    # Resource limits (production)
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

    # Environment variables
    environment:
      <<: *env
    env_file:
      - .env

    # Volume Mounts
    volumes:
      # Wiki Documents
      - ./docs/wiki:/app/docs/wiki
      # Logs directory
      - ./logs:/app/logs
      # Testing (Development only - remove in production)
      - ./tests:/app/tests
      - ./frontend/tests:/app/frontend/tests

    # Port mapping (Ash-Dash: 30883)
    ports:
      - "30883:30883"

    # Docker Secrets
    secrets:
      - archive_master_key
      - ash_dash_discord_alert_token
      - minio_root_user
      - minio_root_password
      - oidc_client_secret
      - postgres_token
      - redis_token

    # Health check - uses HTTP endpoint
    healthcheck:
      <<: *health
      test: ["CMD", "curl", "-f", "http://localhost:30883/health"]

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    # Labels for organization
    labels:
      - "net.alphabetcartel.service=ash-dash"
      - "net.alphabetcartel.version=5.0.0"
      - "net.alphabetcartel.description=Ash Crisis Detection Dashboard"

    # Dependencies - wait for database to be healthy
    depends_on:
      ash-dash-db:
        condition: service_healthy

  # ===========================================================================
  # PostgreSQL Database - Ash-Dash Data Store
  # ===========================================================================
  ash-dash-db:
    image: postgres:16-alpine
    container_name: ash-dash-db
    <<: *common

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"

    # Environment variables
    environment:
      <<: *env
      POSTGRES_USER: ash
      POSTGRES_DB: ashdash
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_token

    # Volume Mounts
    volumes:
      - ash-dash-db-data:/var/lib/postgresql/data

    # Docker Secrets
    secrets:
      - postgres_token

    # Health check
    healthcheck:
      <<: *health
      test: ["CMD-SHELL", "pg_isready -U ash -d ashdash"]

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Labels
    labels:
      - "net.alphabetcartel.service=ash-dash-db"
      - "net.alphabetcartel.description=Ash-Dash PostgreSQL Database"

# =============================================================================
# Volumes
# =============================================================================
volumes:
  ash-dash-db-data:
    name: ash-dash-db-data
    driver: local

# =============================================================================
# Secrets
# =============================================================================
secrets:
  archive_master_key:
    file: ./secrets/archive_master_key
  ash_dash_discord_alert_token:
    file: ./secrets/ash_dash_discord_alert_token
  minio_root_user:
    file: ./secrets/minio_root_user
  minio_root_password:
    file: ./secrets/minio_root_password
  oidc_client_secret:
    file: ./secrets/oidc_client_secret
  postgres_token:
    file: ./secrets/postgres_token
  redis_token:
    file: ./secrets/redis_token

# =============================================================================
# Networks
# =============================================================================
networks:
  ash-network:
    name: ash-network
    driver: bridge
    external: true
