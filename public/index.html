<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ash Analytics Dashboard - The Alphabet Cartel</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.4/dist/socket.io.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-online {
            color: #10b981;
        }
        
        .status-offline {
            color: #ef4444;
        }
        
        .status-warning {
            color: #f59e0b;
        }
        
        .metric-card {
            transition: transform 0.2s ease-in-out;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .crisis-high {
            background: linear-gradient(45deg, #fee2e2, #fecaca);
            border-left: 4px solid #dc2626;
        }
        
        .crisis-medium {
            background: linear-gradient(45deg, #fef3c7, #fde68a);
            border-left: 4px solid #d97706;
        }
        
        .crisis-low {
            background: linear-gradient(45deg, #dbeafe, #bfdbfe);
            border-left: 4px solid #2563eb;
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-heart text-purple-600 text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Ash Analytics Dashboard</h1>
                        <p class="text-sm opacity-80">The Alphabet Cartel Crisis Detection Analytics</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-sm opacity-80">Last Updated</p>
                        <p class="text-sm font-mono" id="lastUpdated">--:--:--</p>
                    </div>
                    <div class="w-3 h-3 rounded-full" id="connectionStatus"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Service Status Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 rounded-lg p-6 glass-effect metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Ash Bot Status</h3>
                        <p class="text-2xl font-bold" id="botStatus">Checking...</p>
                        <p class="text-sm text-gray-400" id="botResponseTime">Response: --ms</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center">
                        <i class="fas fa-robot text-xl" id="botIcon"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg p-6 glass-effect metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">NLP Server Status</h3>
                        <p class="text-2xl font-bold" id="nlpStatus">Checking...</p>
                        <p class="text-sm text-gray-400" id="nlpResponseTime">Response: --ms</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center">
                        <i class="fas fa-brain text-xl" id="nlpIcon"></i>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg p-6 glass-effect metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Learning System</h3>
                        <p class="text-2xl font-bold" id="learningStatus">Active</p>
                        <p class="text-sm text-gray-400" id="learningStats">Adaptations: --</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-xl text-green-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crisis Detection Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 rounded-lg p-6 glass-effect metric-card crisis-high">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold text-red-800">High Crisis</h4>
                        <p class="text-3xl font-bold text-red-900" id="highCrisis">0</p>
                        <p class="text-sm text-red-700">Last 24h</p>
                    </div>
                    <i class="fas fa-exclamation-triangle text-2xl text-red-700"></i>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg p-6 glass-effect metric-card crisis-medium">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold text-orange-800">Medium Crisis</h4>
                        <p class="text-3xl font-bold text-orange-900" id="mediumCrisis">0</p>
                        <p class="text-sm text-orange-700">Last 24h</p>
                    </div>
                    <i class="fas fa-exclamation-circle text-2xl text-orange-700"></i>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg p-6 glass-effect metric-card crisis-low">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold text-blue-800">Low Crisis</h4>
                        <p class="text-3xl font-bold text-blue-900" id="lowCrisis">0</p>
                        <p class="text-sm text-blue-700">Last 24h</p>
                    </div>
                    <i class="fas fa-info-circle text-2xl text-blue-700"></i>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg p-6 glass-effect metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold text-gray-300">Total Analyzed</h4>
                        <p class="text-3xl font-bold text-white" id="totalAnalyzed">0</p>
                        <p class="text-sm text-gray-400">Messages processed</p>
                    </div>
                    <i class="fas fa-chart-line text-2xl text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Crisis Trends Chart -->
            <div class="bg-gray-800 rounded-lg p-6 glass-effect">
                <h3 class="text-lg font-semibold mb-4">Crisis Detection Trends (24h)</h3>
                <div class="relative h-64">
                    <canvas id="crisisTrendsChart"></canvas>
                </div>
            </div>

            <!-- Learning Effectiveness Chart -->
            <div class="bg-gray-800 rounded-lg p-6 glass-effect">
                <h3 class="text-lg font-semibold mb-4">Learning System Performance</h3>
                <div class="relative h-64">
                    <canvas id="learningChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Learning Statistics Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-800 rounded-lg p-6 glass-effect">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-adjust mr-2"></i>False Positive Learning
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total Reports:</span>
                        <span id="fpReports">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Adjustments Made:</span>
                        <span id="fpAdjustments">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Avg Adjustment:</span>
                        <span id="fpAvgAdjustment">--%</span>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" id="fpProgress" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Improvement Rate</p>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg p-6 glass-effect">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-search-plus mr-2"></i>False Negative Learning
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total Reports:</span>
                        <span id="fnReports">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Adjustments Made:</span>
                        <span id="fnAdjustments">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Avg Adjustment:</span>
                        <span id="fnAvgAdjustment">--%</span>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" id="fnProgress" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Improvement Rate</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="bg-gray-800 rounded-lg p-6 glass-effect">
            <h3 class="text-lg font-semibold mb-4">
                <i class="fas fa-clock mr-2"></i>Recent Learning Activities
            </h3>
            <div class="space-y-3" id="recentActivities">
                <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-2 h-2 bg-green-400 rounded-full pulse"></div>
                        <span class="text-sm">Loading recent activities...</span>
                    </div>
                    <span class="text-xs text-gray-400">--:--</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 border-t border-gray-700 py-6 mt-12">
        <div class="container mx-auto px-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <p class="text-sm text-gray-400">
                        Â© 2025 The Alphabet Cartel | Built with ðŸ–¤ for chosen family
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="https://discord.gg/alphabetcartel" target="_blank" 
                       class="text-gray-400 hover:text-white transition-colors">
                        <i class="fab fa-discord text-lg"></i>
                    </a>
                    <a href="https://github.com/The-Alphabet-Cartel" target="_blank"
                       class="text-gray-400 hover:text-white transition-colors">
                        <i class="fab fa-github text-lg"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Chart instances
        let crisisTrendsChart, learningChart;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadInitialData();
            setupSocketListeners();
            startPeriodicUpdates();
        });

        function initializeCharts() {
            // Crisis Trends Chart
            const crisisCtx = document.getElementById('crisisTrendsChart').getContext('2d');
            crisisTrendsChart = new Chart(crisisCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'High Crisis',
                        data: [],
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Medium Crisis',
                        data: [],
                        borderColor: '#d97706',
                        backgroundColor: 'rgba(217, 119, 6, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Low Crisis',
                        data: [],
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#f3f4f6' }
                        }
                    }
                }
            });

            // Learning Chart
            const learningCtx = document.getElementById('learningChart').getContext('2d');
            learningChart = new Chart(learningCtx, {
                type: 'doughnut',
                data: {
                    labels: ['False Positive Fixes', 'False Negative Fixes', 'Pending'],
                    datasets: [{
                        data: [0, 0, 100],
                        backgroundColor: ['#10b981', '#3b82f6', '#6b7280'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#f3f4f6' }
                        }
                    }
                }
            });
        }

        async function loadInitialData() {
            try {
                updateLastUpdated();
                await Promise.all([
                    updateServiceStatus(),
                    updateMetrics(),
                    updateLearningStats(),
                    updateCrisisTrends()
                ]);
            } catch (error) {
                console.error('Error loading initial data:', error);
                showError('Failed to load dashboard data');
            }
        }

        async function updateServiceStatus() {
            try {
                const response = await fetch('http://10.20.30.253:8882/api/status');
                const data = await response.json();

                // Update bot status
                updateServiceDisplay('bot', data.bot || { status: 'unknown' });
                updateServiceDisplay('nlp', data.nlp_server || { status: 'unknown' });

            } catch (error) {
                console.error('Error updating service status:', error);
                updateServiceDisplay('bot', { status: 'offline', error: 'Connection failed' });
                updateServiceDisplay('nlp', { status: 'offline', error: 'Connection failed' });
            }
        }

        function updateServiceDisplay(service, status) {
            const statusElement = document.getElementById(`${service}Status`);
            const responseTimeElement = document.getElementById(`${service}ResponseTime`);
            const iconElement = document.getElementById(`${service}Icon`);

            if (status.status === 'ready' || status.status === 'connected' || status.status === 'online') {
                statusElement.textContent = 'Online';
                statusElement.className = 'text-2xl font-bold status-online';
                iconElement.className = iconElement.className.replace(/text-\w+-\d+/, 'text-green-400');
                responseTimeElement.textContent = `Response: ${status.response_time || 0}ms`;
            } else {
                statusElement.textContent = 'Offline';
                statusElement.className = 'text-2xl font-bold status-offline';
                iconElement.className = iconElement.className.replace(/text-\w+-\d+/, 'text-red-400');
                responseTimeElement.textContent = status.error || 'Connection failed';
            }
        }

        async function updateMetrics() {
            try {
                const response = await fetch('http://10.20.30.253:8882/api/metrics');
                const data = await response.json();

                // Update crisis detection numbers
                document.getElementById('highCrisis').textContent = data.crisis_stats?.high || 0;
                document.getElementById('mediumCrisis').textContent = data.crisis_stats?.medium || 0;
                document.getElementById('lowCrisis').textContent = data.crisis_stats?.low || 0;
                document.getElementById('totalAnalyzed').textContent = data.bot_stats?.messages_processed || 0;

            } catch (error) {
                console.error('Error updating metrics:', error);
            }
        }

        async function updateLearningStats() {
            try {
                const response = await fetch('http://10.20.30.253:8882/api/learning-stats');
                const data = await response.json();

                // Update false positive stats
                document.getElementById('fpReports').textContent = data.false_positive_reports || 0;
                document.getElementById('fpAdjustments').textContent = data.total_adjustments || 0;
                document.getElementById('fpAvgAdjustment').textContent = '0.0%';
                
                // Update false negative stats
                document.getElementById('fnReports').textContent = data.false_negative_reports || 0;
                document.getElementById('fnAdjustments').textContent = data.total_adjustments || 0;
                document.getElementById('fnAvgAdjustment').textContent = '0.0%';

                // Update learning status
                const totalReports = (data.false_positive_reports || 0) + (data.false_negative_reports || 0);
                document.getElementById('learningStats').textContent = `Adaptations: ${totalReports}`;

                // Update progress bars
                const fpProgress = Math.min(100, (data.total_adjustments || 0) * 10);
                const fnProgress = Math.min(100, (data.total_adjustments || 0) * 10);
                
                document.getElementById('fpProgress').style.width = fpProgress + '%';
                document.getElementById('fnProgress').style.width = fnProgress + '%';

                // Update learning chart
                learningChart.data.datasets[0].data = [
                    data.false_positive_reports || 0,
                    data.false_negative_reports || 0,
                    Math.max(0, 100 - ((data.false_positive_reports || 0) + (data.false_negative_reports || 0)))
                ];
                learningChart.update();

            } catch (error) {
                console.error('Error updating learning stats:', error);
            }
        }

        async function updateCrisisTrends() {
            try {
                const response = await fetch('http://10.20.30.253:8882/api/crisis-trends?timeframe=24h');
                const data = await response.json();

                if (data.trends) {
                    crisisTrendsChart.data.labels = data.trends.labels || [];
                    crisisTrendsChart.data.datasets[0].data = data.trends.high || [];
                    crisisTrendsChart.data.datasets[1].data = data.trends.medium || [];
                    crisisTrendsChart.data.datasets[2].data = data.trends.low || [];
                    crisisTrendsChart.update();
                }

            } catch (error) {
                console.error('Error updating crisis trends:', error);
            }
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
                document.getElementById('connectionStatus').className = 'w-3 h-3 rounded-full bg-green-400 pulse';
                socket.emit('subscribe_metrics');
            });

            socket.on('disconnect', () => {
                document.getElementById('connectionStatus').className = 'w-3 h-3 rounded-full bg-red-400';
            });

            socket.on('metrics_update', (data) => {
                updateLastUpdated();
                updateMetrics();
                updateLearningStats();
            });
        }

        function startPeriodicUpdates() {
            // Update every 5 minutes
            setInterval(() => {
                updateServiceStatus();
                updateMetrics();
                updateLearningStats();
                updateCrisisTrends();
            }, 5 * 60 * 1000);

            // Update time every second
            setInterval(updateLastUpdated, 1000);
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
        }

        function showError(message) {
            console.error(message);
        }
    </script>
</body>
</html>