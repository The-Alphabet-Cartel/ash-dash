<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ash Analytics Dashboard - The Alphabet Cartel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }
        .status-warning { color: #f59e0b; }
        
        .metric-card {
            transition: transform 0.2s ease-in-out;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading::after {
            content: "Loading...";
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Ash Analytics Dashboard</h1>
                    <p class="text-gray-600">Crisis Detection Analytics for <a href="https://discord.gg/alphabetcartel" class="text-blue-600 hover:text-blue-800" target="_blank">The Alphabet Cartel</a></p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        Last updated: <span id="last-updated">Never</span>
                    </div>
                    <button id="refresh-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Service Status Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Ash Bot Status -->
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Ash Bot</h3>
                        <p class="text-sm text-gray-500">Crisis Detection Bot</p>
                    </div>
                    <div class="text-right">
                        <div id="bot-status" class="text-lg font-semibold">Checking...</div>
                        <div id="bot-response-time" class="text-sm text-gray-500">-</div>
                    </div>
                </div>
                <div id="bot-error" class="mt-2 text-sm text-red-600 hidden"></div>
            </div>

            <!-- NLP Server Status -->
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">NLP Server</h3>
                        <p class="text-sm text-gray-500">ML Analysis Engine</p>
                    </div>
                    <div class="text-right">
                        <div id="nlp-status" class="text-lg font-semibold">Checking...</div>
                        <div id="nlp-response-time" class="text-sm text-gray-500">-</div>
                    </div>
                </div>
                <div id="nlp-error" class="mt-2 text-sm text-red-600 hidden"></div>
            </div>

            <!-- Learning System Status -->
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Learning System</h3>
                        <p class="text-sm text-gray-500">Model Adaptation</p>
                    </div>
                    <div class="text-right">
                        <div id="learning-status" class="text-lg font-semibold">Checking...</div>
                        <div id="learning-activity" class="text-sm text-gray-500">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crisis Detection Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <h3 class="text-lg font-medium text-gray-900 mb-2">High Crisis</h3>
                <div class="text-3xl font-bold text-red-600" id="high-crisis">0</div>
                <p class="text-sm text-gray-500">Last 24h</p>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Medium Crisis</h3>
                <div class="text-3xl font-bold text-yellow-600" id="medium-crisis">0</div>
                <p class="text-sm text-gray-500">Last 24h</p>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Low Crisis</h3>
                <div class="text-3xl font-bold text-blue-600" id="low-crisis">0</div>
                <p class="text-sm text-gray-500">Last 24h</p>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Total Analyzed</h3>
                <div class="text-3xl font-bold text-gray-900" id="total-messages">0</div>
                <p class="text-sm text-gray-500">Messages</p>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Crisis Trends Chart -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Crisis Detection Trends</h3>
                <div class="chart-container">
                    <canvas id="crisis-trends-chart"></canvas>
                </div>
            </div>

            <!-- Learning System Chart -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Learning System Activity</h3>
                <div class="chart-container">
                    <canvas id="learning-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Learning Statistics -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Learning System Statistics</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="false-positive-learning">0</div>
                    <p class="text-sm text-gray-500">False Positive Reports</p>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600" id="false-negative-learning">0</div>
                    <p class="text-sm text-gray-500">False Negative Reports</p>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="total-adjustments">0</div>
                    <p class="text-sm text-gray-500">Model Adjustments</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <p class="text-center text-sm text-gray-500">
                Ash Analytics Dashboard - Supporting mental health in <a href="https://discord.gg/alphabetcartel" class="text-blue-600 hover:text-blue-800" target="_blank">The Alphabet Cartel</a> community
            </p>
        </div>
    </footer>

    <script>
        // Configuration
        const API_BASE = ''; // Use relative URLs to avoid HTTPS/HTTP issues
        const UPDATE_INTERVAL = 5 * 60 * 1000; // 5 minutes
        
        // Global variables
        let socket;
        let charts = {};
        let updateTimer;
        
        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            initializeSocket();
            loadInitialData();
            setupEventListeners();
            startAutoUpdate();
        });
        
        // Socket.IO initialization
        function initializeSocket() {
            try {
                socket = io();
                
                socket.on('connect', function() {
                    console.log('Connected to dashboard socket');
                    socket.emit('subscribe_metrics');
                });
                
                socket.on('metrics_update', function(data) {
                    console.log('Received real-time metrics update');
                    updateDisplayWithData(data);
                });
                
                socket.on('disconnect', function() {
                    console.log('Disconnected from dashboard socket');
                });
                
                socket.on('error', function(error) {
                    console.error('Socket error:', error);
                });
            } catch (error) {
                console.error('Failed to initialize socket:', error);
            }
        }
        
        // Event listeners
        function setupEventListeners() {
            document.getElementById('refresh-btn').addEventListener('click', function() {
                console.log('Manual refresh triggered');
                loadInitialData();
            });
        }
        
        // Auto-update timer
        function startAutoUpdate() {
            updateTimer = setInterval(loadInitialData, UPDATE_INTERVAL);
        }
        
        // Load all initial data
        async function loadInitialData() {
            console.log('Loading initial data...');
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            
            try {
                await Promise.all([
                    updateServiceStatus(),
                    updateMetrics(),
                    updateLearningStats(),
                    updateCrisisTrends('24h')
                ]);
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }
        
        // Update service status
        async function updateServiceStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // Update Bot Status
                const botStatus = data.services?.bot?.status || 'offline';
                const botElement = document.getElementById('bot-status');
                const botResponseTime = document.getElementById('bot-response-time');
                const botError = document.getElementById('bot-error');
                
                botElement.textContent = botStatus.charAt(0).toUpperCase() + botStatus.slice(1);
                botElement.className = `text-lg font-semibold status-${botStatus}`;
                
                if (data.services?.bot?.response_time) {
                    botResponseTime.textContent = `${data.services.bot.response_time}ms`;
                } else {
                    botResponseTime.textContent = '-';
                }
                
                if (data.services?.bot?.error) {
                    botError.textContent = data.services.bot.error;
                    botError.classList.remove('hidden');
                } else {
                    botError.classList.add('hidden');
                }
                
                // Update NLP Status
                const nlpStatus = data.services?.nlp?.status || 'offline';
                const nlpElement = document.getElementById('nlp-status');
                const nlpResponseTime = document.getElementById('nlp-response-time');
                const nlpError = document.getElementById('nlp-error');
                
                nlpElement.textContent = nlpStatus.charAt(0).toUpperCase() + nlpStatus.slice(1);
                nlpElement.className = `text-lg font-semibold status-${nlpStatus}`;
                
                if (data.services?.nlp?.response_time) {
                    nlpResponseTime.textContent = `${data.services.nlp.response_time}ms`;
                } else {
                    nlpResponseTime.textContent = '-';
                }
                
                if (data.services?.nlp?.error) {
                    nlpError.textContent = data.services.nlp.error;
                    nlpError.classList.remove('hidden');
                } else {
                    nlpError.classList.add('hidden');
                }
                
            } catch (error) {
                console.error('Error updating service status:', error);
                // Set all services to offline on error
                document.getElementById('bot-status').textContent = 'Offline';
                document.getElementById('bot-status').className = 'text-lg font-semibold status-offline';
                document.getElementById('nlp-status').textContent = 'Offline';
                document.getElementById('nlp-status').className = 'text-lg font-semibold status-offline';
            }
        }
        
        // Update crisis detection metrics
        async function updateMetrics() {
            try {
                const response = await fetch(`${API_BASE}/api/metrics`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // Update crisis metrics with fallback to 0
                document.getElementById('high-crisis').textContent = data.crisis_metrics?.high || 0;
                document.getElementById('medium-crisis').textContent = data.crisis_metrics?.medium || 0;
                document.getElementById('low-crisis').textContent = data.crisis_metrics?.low || 0;
                document.getElementById('total-messages').textContent = data.total_messages_analyzed || 0;
                
            } catch (error) {
                console.error('Error updating metrics:', error);
                // Set fallback values
                document.getElementById('high-crisis').textContent = '0';
                document.getElementById('medium-crisis').textContent = '0';
                document.getElementById('low-crisis').textContent = '0';
                document.getElementById('total-messages').textContent = '0';
            }
        }
        
        // Update learning system statistics
        async function updateLearningStats() {
            try {
                const response = await fetch(`${API_BASE}/api/learning-stats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // Update learning system status
                const learningStatus = data.status || 'offline';
                document.getElementById('learning-status').textContent = learningStatus.charAt(0).toUpperCase() + learningStatus.slice(1);
                document.getElementById('learning-status').className = `text-lg font-semibold status-${learningStatus}`;
                
                // Update learning statistics
                document.getElementById('false-positive-learning').textContent = data.false_positive_reports || 0;
                document.getElementById('false-negative-learning').textContent = data.false_negative_reports || 0;
                document.getElementById('total-adjustments').textContent = data.total_adjustments || 0;
                
                // Update activity indicator
                const lastUpdate = data.last_update ? new Date(data.last_update).toLocaleString() : 'Never';
                document.getElementById('learning-activity').textContent = `Updated: ${lastUpdate}`;
                
            } catch (error) {
                console.error('Error updating learning stats:', error);
                document.getElementById('learning-status').textContent = 'Offline';
                document.getElementById('learning-status').className = 'text-lg font-semibold status-offline';
                document.getElementById('false-positive-learning').textContent = '0';
                document.getElementById('false-negative-learning').textContent = '0';
                document.getElementById('total-adjustments').textContent = '0';
                document.getElementById('learning-activity').textContent = 'No data';
            }
        }
        
        // Update crisis trends chart
        async function updateCrisisTrends(timeframe) {
            try {
                const response = await fetch(`${API_BASE}/api/crisis-trends?timeframe=${timeframe}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // Create or update crisis trends chart
                const ctx = document.getElementById('crisis-trends-chart').getContext('2d');
                
                if (charts.crisisTrends) {
                    charts.crisisTrends.destroy();
                }
                
                charts.crisisTrends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels || ['No Data'],
                        datasets: [{
                            label: 'High Crisis',
                            data: data.high || [0],
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Medium Crisis',
                            data: data.medium || [0],
                            borderColor: 'rgb(245, 158, 11)',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Low Crisis',
                            data: data.low || [0],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: `Crisis Detection - Last ${timeframe}`
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error updating crisis trends:', error);
                // Create empty chart on error
                const ctx = document.getElementById('crisis-trends-chart').getContext('2d');
                if (charts.crisisTrends) {
                    charts.crisisTrends.destroy();
                }
                
                charts.crisisTrends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['No Data Available'],
                        datasets: [{
                            label: 'No Data',
                            data: [0],
                            borderColor: 'rgb(156, 163, 175)',
                            backgroundColor: 'rgba(156, 163, 175, 0.1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Crisis Detection Trends - No Data Available'
                            }
                        }
                    }
                });
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (updateTimer) {
                clearInterval(updateTimer);
            }
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>